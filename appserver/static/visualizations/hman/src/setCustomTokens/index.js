const SplunkVisualizationBase = require('api/SplunkVisualizationBase'); // eslint-disable-line no-unused-vars
/**
 * Emits a native-style Simple XML drilldown event scoped to this component.
 *
 * Token lifecycle (mirrors visualizationview._emitDrilldownEvent → eventhandler.handleEvent):
 *   1. Build a drilldown data object with click.* and row.* fields
 *   2. Wrap it in a payload with preventDefault/drilldown helpers
 *   3. Trigger 'drilldown' on the component — the EventHandler that is
 *      bound to THIS component's viewid picks it up and resolves
 *      $row.<field>$, $click.value$, etc. from e.data into named tokens.
 *   4. Only explicitly <set> tokens are written to global token models.
 *      row.* / click.* stay inside the event payload (component-scoped).
 */
const _setCustomTokens = function (params, tmpChartInstance) {

    var mvc = this.splunkjs.mvc;

    // Get component ID
    var splunkAutoGeneratedComponentId = tmpChartInstance._dom.closest('.dashboard-element.viz')?.id;
    var activeVizComponent = mvc.Components.get(splunkAutoGeneratedComponentId);

    if (!activeVizComponent) {
        console.warn('_setCustomTokens: could not resolve viz component for drilldown');
        return;
    }

    // ── 1. Build normalised drilldown data (same shape as normalizeDrilldownEventData) ──
    var drilldownData = {};

    if (params.dimensionNames && params.data.value) {
        // Populate row.<fieldName> tokens — carried inside the event, NOT on global models
        params.dimensionNames.forEach(function (dimensionName, index) {
            if (params.data.value[index] !== undefined) {
                drilldownData['row.' + dimensionName] = String(params.data.value[index]);
            }
        });

        // click.name / click.value — use the first dimension as the "clicked" field
        var clickName  = params.dimensionNames[0] || '';
        var clickValue = params.data.value[0] !== undefined ? String(params.data.value[0]) : '';

        drilldownData['click.name']   = clickName;
        drilldownData['click.value']  = clickValue;
        drilldownData['click.name2']  = clickName;
        drilldownData['click.value2'] = clickValue;
    }

    // ── 2. Build the event payload (same contract as Drilldown.createEventPayload) ──
    var defaultPrevented = false;
    var drilldownPayload = {
        field: drilldownData['click.name'] || '',
        data:  drilldownData,
        event: params,
        preventDefault: function () {
            defaultPrevented = true;
        },
        defaultPrevented: function () {
            return defaultPrevented;
        },
        drilldown: function () { /* no-op — default action handled by EventHandler */ }
    };

    // ── 3. Trigger on the component so EventHandler (bound via viewid) picks it up ──
    activeVizComponent.trigger('drilldown', drilldownPayload);
}

module.exports = _setCustomTokens;