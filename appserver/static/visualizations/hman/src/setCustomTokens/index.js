const SplunkVisualizationBase = require('api/SplunkVisualizationBase'); // eslint-disable-line no-unused-vars
/**
 * To be called after a timeline custom render item was clicked upon.
 * Sets $row.<fieldName>$ tokens to match native Simple XML drilldown behavior.
*/
const _setCustomTokens = function (params, tmpChartInstance) {

    // Get token models
    var defaultTokenModel = this.splunkjs.mvc.Components.get("default");
    var submittedTokenModel = this.splunkjs.mvc.Components.get("submitted");

    // Get component ID
    var splunkAutoGeneratedComponentId = tmpChartInstance._dom.closest('.dashboard-element.viz')?.id;
    var activeVizComponent = this.splunkjs.mvc.Components.get(splunkAutoGeneratedComponentId);

    // Set tokens for drilldown
    console.log('Set tokens for drilldown...');

    // Build row token data matching native Simple XML drilldown format: $row.<fieldName>$
    var rowTokenData = {};
    if (params.dimensionNames && params.data.value) {
        params.dimensionNames.forEach(function(dimensionName, index) {
            if (params.data.value[index] !== undefined) {
                var tokenValue = String(params.data.value[index]);

                // Set native $row.<fieldName>$ tokens
                rowTokenData['row.' + dimensionName] = tokenValue;
                defaultTokenModel.set('row.' + dimensionName, tokenValue);

                // Also set bare $<fieldName>$ tokens for backwards compatibility
                defaultTokenModel.set(dimensionName, tokenValue);

                // Mirror to submitted token model if it exists (required for form inputs)
                if (submittedTokenModel) {
                    submittedTokenModel.set('row.' + dimensionName, tokenValue);
                    submittedTokenModel.set(dimensionName, tokenValue);
                }
            }
        });
    }

    // Execute this code only if there is a drilldown definition associated with the custom visualisation
    if(typeof activeVizComponent._events !== 'undefined' && typeof activeVizComponent._events.drilldown !== 'undefined') {

        //Re-render the drilldown link associated with the active visualisation
        var drilldownDynamicLink = activeVizComponent._events.drilldown[0].ctx.attributes.actions[0].value;

        // Dynamically replace all token placeholders ($row.<fieldName>$ and $<fieldName>$) in the drilldown link
        if (params.dimensionNames && params.data.value) {
            params.dimensionNames.forEach(function(dimensionName, index) {
                var tokenValue = params.data.value[index];
                var encodedValue = tokenValue ? encodeURIComponent(tokenValue) : '';

                // Replace $row.<fieldName>$ placeholders
                drilldownDynamicLink = drilldownDynamicLink.replace(
                    '$row.' + dimensionName + '$',
                    encodedValue
                );
                // Replace bare $<fieldName>$ placeholders for backwards compatibility
                drilldownDynamicLink = drilldownDynamicLink.replace(
                    '$' + dimensionName + '$',
                    encodedValue
                );
            });
        }

        activeVizComponent._events.drilldown[0].ctx.attributes.actions[0].value = drilldownDynamicLink;

        // Simulate native Simple XML drilldown with row.* fields in the event data
        var drilldownEventData = {
            name: 'click',
            value: 'drilldown',
            data: {
                click: 'row',
                name: 'customDrilldown',
                value: params.data.value,
            }
        };

        // Merge row.* fields into event data (matches normalizeDrilldownEventData format)
        for (var key in rowTokenData) {
            if (rowTokenData.hasOwnProperty(key)) {
                drilldownEventData.data[key] = rowTokenData[key];
            }
        }

        activeVizComponent.trigger('drilldown', drilldownEventData);
    }
}

module.exports = _setCustomTokens;