/**
 * To be called after a timeline custom render item was clicked upon
*/
const _setCustomTokens = function (params, tmpChartInstance) {
    
    // Get token models
    var defaultTokenModel = this.splunkjs.mvc.Components.get("default");

    // Get component ID
    var splunkAutoGeneratedComponentId = tmpChartInstance._dom.closest('.dashboard-element.viz')?.id;
    var activeVizComponent = this.splunkjs.mvc.Components.get(splunkAutoGeneratedComponentId);
    
    // Set tokens for drilldown
    console.log('Set tokens for drilldown...');
    var tokenValues = {};

    // Loop through dimensionNames and set tokens dynamically
    if (params.dimensionNames && params.data.value) {
        params.dimensionNames.forEach(function(dimensionName, index) {
            if (params.data.value[index] !== undefined) {
                var tokenName = dimensionName;
                defaultTokenModel.set(tokenName, params.data.value[index]);
                tokenValues[dimensionName] = params.data.value[index];
            }
        });
    }

    // Execute this code only if there is a drilldown definition associated with the custom visualisation
    if(typeof activeVizComponent._events !== 'undefined' && typeof activeVizComponent._events.drilldown !== 'undefined') {

        //Re-render the drilldown link associated with the active visualisation
        var drilldownDynamicLink = activeVizComponent._events.drilldown[0].ctx.attributes.actions[0].value;

        // Dynamically replace all token placeholders in the drilldown link
        if (params.dimensionNames && params.data.value) {
            params.dimensionNames.forEach(function(dimensionName, index) {
                var tokenPlaceholder = '$' + dimensionName + '$';
                var tokenValue = params.data.value[index];
                drilldownDynamicLink = drilldownDynamicLink.replace(
                    tokenPlaceholder,
                    tokenValue ? encodeURIComponent(tokenValue) : ''
                );
            });
        }

        activeVizComponent._events.drilldown[0].ctx.attributes.actions[0].value = drilldownDynamicLink;

        // Simulate native splunk drilldown
        activeVizComponent.trigger('drilldown', {
            name: 'click',
            value: 'drilldown',
            data: {
                click: 'row',   // or 'cell'
                name: 'customDrilldown',    // passed to click.name when data.click = 'cell'
                value: params.data.value,   // Pass all values from the data array
            }
        });
    }
}

module.exports = _setCustomTokens;